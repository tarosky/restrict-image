{"version":3,"sources":["components/uploader.js"],"names":["$","Vue","component","percentile","dropMsg","TaroimgUploader","uploading","undroppable","round","FileReader","btnLabel","nonce","loaded","methods","upload","props","directory","type","required","self","url","method","dataType","data","formData","xhr","actionUrl","XHR","endpoint","this","total","Math","reset","submitForm","ajax","$form","processData","contentType","ajaxSettings","openFile","$refs","dispatchEvent","Event","e","done","res","fileChangeHandler","event","target","fail","response","$emit","always","dragOver","onDrag","dragEnter","form","FormData","dragLeave","file","files","length","dropHandler","dataTransfer","stopPropagation","append","jQuery"],"mappings":";;;;;;;;;;;CAMA,SAAAA,GAOEC,IAAIC,UAAU,oBAAdD,SAAAA,8vCA+DIE,KAAAA,WACE,OACEC,QAAOC,gBAAPD,QACDE,WAAI,EACHC,aAAYC,OAAOC,WACpBC,SAAAL,gBAAAK,SACFC,MAAAN,gBAAAM,MArE6BC,OAAA,EAuEhCC,MAAS,EACPC,QAAQ,IAGJC,OACDC,WACDC,KAAKX,OACLY,UAAIC,GAEFC,QACAC,KAAAA,OACAC,UAAAA,EACAC,QAAMC,IAGNC,UACEC,UAAIC,WACJ,OAAAtB,gBAAcuB,SAAAC,KAAAb,WAEVG,OAAAA,WACAA,MAAAA,WAAAU,KAAgBC,WAEnB3B,WAAA,WACD,OAAA0B,KAAAC,MAGFC,KAASC,MAATH,KAAAjB,OAAAiB,KAAAC,MAAA,KAAA,IAFC,KAMFjB,SACCM,OAAAA,SAAKb,EAAYkB,GAEjBL,IAAAA,KAAKW,UAALX,CA3BFU,KAAKvB,WAAY,EA+BnB2B,IAAAA,EAAYJ,KACV7B,EAAAkC,MACAd,IAAIe,EAAQnC,KAAE,UACdqB,OAAIG,OACJF,SAAYa,OAzCPZ,KAAAC,EAaHY,aAAa,EA+BjBC,aAAA,EA7BIZ,IAAM,WACJ,IAAIE,EAAM3B,EAAEsC,aAAab,MAOzB,OAwBNc,EAAUzB,QACH0B,EAAL1B,OAAgB2B,iBAAkBC,WAAM,SAAxCC,GAhDKxB,EAAAP,OAAA+B,EAAA/B,OAoBGO,EAAKW,MAASa,EAAEb,QA+B1B,GA5BaH,KAERiB,KAAK,SAAUC,GA+BpBC,EAAAA,GAAAA,QACE3B,EAAG4B,MAAMC,kBAAoBH,KAC3BI,KAAKhB,SAALiB,GACD/B,EAAAgC,MAAA,eAAAD,KA3DIE,OAAA,WA+BHjC,EAAKb,WAAY,EA+BrB+C,EAAAA,OAAU,EACRlC,EAAKmC,MAAS,MAIhBC,WAAW,WAnEJ,IAAApB,EAAAnC,EAAA6B,KAAAW,MAAAgB,MAwCDhC,EAAW,IAAIiC,SAAU5B,KAAKW,MAAMgB,MA+B1CE,KAAAA,OAAWvB,EAAAX,IAMTe,SAAIQ,WACFlB,KAAAW,MAAOmB,KAAPlB,cAAA,IAAAC,MAAA,WAQFI,kBAAcU,SAAOhC,GACrBuB,EAAOC,OAAPY,MAAAC,QACDhC,KAAAI,cA1BDoB,SAAU,SAASN,GAEjB,OADAlB,KAAKyB,QAAS,GACP,GAGTC,UAAW,WACT,OAAO,GAGTG,UAAW,WAET,OADA7B,KAAKyB,QAAS,GACP,GAETQ,YAAa,SAASf,GAEpB,IAAIA,EAAMgB,aAAaH,MAAMC,OAC3B,OAAO,EAETd,EAAMiB,kBAEN,IAAIL,EAAOZ,EAAMgB,aAAaH,MAAM,GAChCJ,EAAO3B,KAAKW,MAAMgB,KAClBhC,EAAW,IAAIiC,SAAUD,GAG7B,OAFAhC,EAASyC,OAAO,OAAQN,GACxB9B,KAAKf,OAAOd,EAAEwD,GAAOhC,IACd,MArKf,CAyKG0C","file":"../../components/uploader.js","sourcesContent":["/*!\n * File uploader\n *\n * wpdeps=jquery,vue-js\n */\n\n/*global TaroimgUploader: false*/\n\n(function ($) {\n\n  'use strict';\n\n\n  Vue.component('taroimg-uploader', {\n    template: `\n    <div>\n\n    <form :action=\"actionUrl\" enctype=\"multipart/form-data\" method=\"post\"\n\t\t\t:class=\"{'taroimg-form': true, undroppable: undroppable, uploading: uploading}\"\n\t\t\t:id=\"formId\"\n\t\t\t@submit.prevent=\"submitForm\" ref=\"form\">\n\t\t\t<input type=\"hidden\" name=\"_wpnonce\" :value=\"nonce\" />\n\t\t\t<input type=\"hidden\" name=\"id\" :value=\"postId\" />\n\t\t\t<div :class=\"{'taroimg-dropzone': true, on: onDrag}\"\n\t\t\t    @dragover.prevent.stop=\"dragOver\"\n\t\t\t    @dragenter.prevent.stop=\"dragEnter\"\n\t\t\t    @dragLeave.prevent.stop=\"dragLeave\"\n\t\t\t    @drop.prevent=\"dropHandler\"\n\t\t\t    >\n\t\t\t\t<p class=\"taroimg-description\">\n\t\t\t\t\t<span v-if=\"!undroppable\" class=\"taroimg-drop-here\">\n\t\t\t\t\t    {{dropMsg}}\n\t\t\t\t\t    <br />\n                    </span>\n\t\t\t\t\t<button class=\"taroimg-button\" type=\"button\" @click=\"openFile\">{{btnLabel}}</button>\n\t\t\t\t</p>\n\t\t\t\t\n\t\t\t\t<div class=\"taroimg-progress-bar\">\n\t\t\t\t\t<div class=\"taroimg-progress-inner\" :style=\"{width: percentile}\"></div>\n\t\t\t\t\t<div class=\"taroimg-progress-text\">{{percentile}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<input class=\"taroimg-input\" type=\"file\" name=\"file\" @change=\"fileChangeHandler\" ref=\"file\">\n    </form>\n    </div>\n    `,\n    data: function(){\n      return {\n        dropMsg: TaroimgUploader.dropMsg,\n        uploading: false,\n        undroppable: !window.FileReader,\n        btnLabel: TaroimgUploader.btnLabel,\n        nonce: TaroimgUploader.nonce,\n        loaded: 0,\n        total: 0,\n        onDrag: false\n      };\n    },\n    props: {\n      directory: {\n        type: String,\n        required: true\n      },\n      postId: {\n        type: Number,\n        required: false,\n        default: 0\n      }\n    },\n    computed: {\n      actionUrl: function(){\n        return TaroimgUploader.endpoint + this.directory;\n      },\n      formId: function(){\n        return `taroimg-${this.directory}`;\n      },\n      percentile: function(){\n        if(!this.total){\n          return '';\n        }else{\n          return Math.round( this.loaded / this.total * 100 ) + '%';\n        }\n      },\n    },\n    methods: {\n      upload: function($form, formData){\n        // Avoid multiple uploading.\n        if(this.uploading){\n          return;\n        }\n        this.uploading = true;\n        let self = this;\n        $.ajax({\n          url: $form.attr('action'),\n          method: 'post',\n          dataType: 'json',\n          data: formData,\n          processData: false,\n          contentType: false,\n          xhr : function(){\n            let XHR = $.ajaxSettings.xhr();\n            if(XHR.upload){\n              XHR.upload.addEventListener('progress',function(e){\n                self.loaded = e.loaded;\n                self.total  = e.total;\n              }, false);\n            }\n            return XHR;\n          }\n        }).done(function( res ) {\n          $form[0].reset();\n          self.$emit('upload-finished', res);\n        }).fail(function( response ) {\n          self.$emit('upload-error', response);\n        }).always(function(){\n          self.uploading = false;\n          self.loaded = 0;\n          self.total  = 0;\n        });\n      },\n\n      submitForm: function(){\n        // Send file via Ajax\n        let $form = $(this.$refs.form);\n        let formData = new FormData( this.$refs.form );\n        this.upload($form, formData);\n      },\n\n      /**\n       * Trigger file select.\n       */\n      openFile: function(){\n        this.$refs.file.dispatchEvent(new Event('click'));\n      },\n\n      /**\n       * Trigger submit if file selected.\n       *\n       * @param {Event} event\n       */\n      fileChangeHandler: function(event){\n        if(event.target.files.length){\n          this.submitForm();\n        }\n      },\n\n      dragOver: function(event){\n        this.onDrag = true;\n        return false;\n      },\n\n      dragEnter: function(){\n        return false;\n      },\n\n      dragLeave: function(){\n        this.onDrag = false;\n        return false;\n      },\n      dropHandler: function(event){\n        // Get file.\n        if(!event.dataTransfer.files.length){\n          return false;\n        }\n        event.stopPropagation();\n        // Only 1 file.\n        let file = event.dataTransfer.files[0];\n        let form = this.$refs.form;\n        let formData = new FormData( form );\n        formData.append('file', file);\n        this.upload($(form), formData);\n        return false;\n      }\n    }\n  });\n})(jQuery);\n"]}