{"version":3,"sources":["components/uploader.js"],"names":["$","Vue","component","data","dropMsg","TaroimgUploader","uploading","methods","window","FileReader","upload","$form","nonce","loaded","total","onDrag","url","method","dataType","contentType","xhr","ajaxSettings","this","directory","XHR","self","e","percentile","Math","round","always","formData","submitForm","attr","processData","openFile","addEventListener","$refs","file","dispatchEvent","done","res","reset","fileChangeHandler","fail","event","files","response","dragOver","form","FormData","dataTransfer","length","jQuery","dragEnter","dragLeave","dropHandler","stopPropagation","append"],"mappings":";;;;;;;;;;;CAMA,SAAAA,GAOEC,IAAIC,UAAU,oBAAdD,SAAAA,qsCA6DQE,KAAA,WACD,OACFC,QAAAC,gBAAAD,QA/D6BE,WAAA,EAiEhCC,aAASC,OAAAC,WACPC,SAAQL,gBAASM,SACfC,MAAAP,gBAAAO,MACAC,OAAG,EACDC,MAAA,EACDC,QAAA,IAGDf,OACEgB,WACAC,KAAAA,OACAC,UAAAA,IAGAC,UACAC,UAAM,WACJ,OAAAf,gBAAYgB,SAAZC,KAAAC,WAEEC,OAAAA,WACEC,MAAAA,WAAKZ,KAASa,WAEfC,WAAE,WACJ,OAAAL,KAAAR,MAGGc,KAAAC,MAAAP,KAAgBT,OAAAS,KAAAR,MAAA,KAAA,IAFpB,KAMFW,SACDf,OAAEoB,SAAOnB,EAAUoB,GAElBN,IAAAA,KAAKZ,UAALY,CAhCGH,KAAAhB,WAAA,EAOL,IAAImB,EAAOH,KA8BbU,EAAAA,MACEhB,IAAAL,EAAAsB,KAAA,UACAhB,OAAIN,OACJO,SAAIa,OACJ5B,KAAKO,EAzCAwB,aAAA,EAcHf,aAAa,EA8BjBC,IAAA,WA5BM,IAAII,EAAMxB,EAAEqB,aAAaD,MAOzB,OANGI,EAAId,QA8BbyB,EAAUzB,OAAA0B,iBAAU,WAAA,SAAAV,GACbW,EAAMC,OAAKC,EAAAA,OAhDXd,EAAAX,MAAAY,EAAAZ,QAqBI,GAEEU,KAERgB,KAAK,SAAUC,GAChB9B,EAAM,GAAG+B,QA8BbC,EAAAA,MAAAA,kBAAmBF,KACjBG,KAAGC,SAAaC,GACdrB,EAAKO,MAAAA,eAALe,KACDjB,OAAA,WA3DIL,EAAAnB,WAAA,EAgCHmB,EAAKZ,OAAS,EA8BlBmC,EAAAA,MAAU,MAzBVhB,WAAY,WA+BV,IAAArB,EAAAX,EAAAsB,KAAAe,MAAAY,MApEKlB,EAAA,IAAAmB,SAAA5B,KAAAe,MAAAY,MAyCL3B,KAAKZ,OAAOC,EAAOoB,IAmCnBI,SAAA,WACAb,KAAIuB,MAAMM,KAAAA,cAAmBC,IAAAA,MAAO,WAQpCrB,kBAAgB,SAAQO,GACxBO,EAAKnC,OAASuC,MAAOlB,QACrBT,KAAOU,cAIZqB,SAjKH,SAAAR,GAsIQ,OADAvB,KAAKP,QAAS,GACP,GAGTuC,UAAW,WACT,OAAO,GAGTC,UAAW,WAET,OADAjC,KAAKP,QAAS,GACP,GAETyC,YAAa,SAASX,GAEpB,IAAIA,EAAMM,aAAaL,MAAMM,OAC3B,OAAO,EAETP,EAAMY,kBAEN,IAAInB,EAAOO,EAAMM,aAAaL,MAAM,GAChCG,EAAO3B,KAAKe,MAAMY,KAClBlB,EAAW,IAAImB,SAAUD,GAG7B,OAFAlB,EAAS2B,OAAO,OAAQpB,GACxBhB,KAAKZ,OAAOV,EAAEiD,GAAOlB,IACd,MA/Jf,CAmKGsB","file":"../../components/uploader.js","sourcesContent":["/*!\n * File uploader\n *\n * wpdeps=jquery,vue-js\n */\n\n/*global TaroimgUploader: false*/\n\n(function ($) {\n\n  'use strict';\n\n\n  Vue.component('taroimg-uploader', {\n    template: `\n    <div>\n\n    <form :action=\"actionUrl\" enctype=\"multipart/form-data\" method=\"post\"\n\t\t\t:class=\"{'taroimg-form': true, undroppable: undroppable, uploading: uploading}\"\n\t\t\t:id=\"formId\"\n\t\t\t@submit.prevent=\"submitForm\" ref=\"form\">\n\t\t\t<input type=\"hidden\" name=\"_wpnonce\" :value=\"nonce\" />\n\t\t\t<div :class=\"{'taroimg-dropzone': true, on: onDrag}\"\n\t\t\t    @dragover.prevent.stop=\"dragOver\"\n\t\t\t    @dragenter.prevent.stop=\"dragEnter\"\n\t\t\t    @dragLeave.prevent.stop=\"dragLeave\"\n\t\t\t    @drop.prevent=\"dropHandler\"\n\t\t\t    >\n\t\t\t\t<p class=\"taroimg-description\">\n\t\t\t\t\t<span v-if=\"!undroppable\" class=\"taroimg-drop-here\">\n\t\t\t\t\t    {{dropMsg}}\n\t\t\t\t\t    <br />\n                    </span>\n\t\t\t\t\t<button class=\"taroimg-button\" type=\"button\" @click=\"openFile\">{{btnLabel}}</button>\n\t\t\t\t</p>\n\t\t\t\t\n\t\t\t\t<div class=\"taroimg-progress-bar\">\n\t\t\t\t\t<div class=\"taroimg-progress-inner\" :style=\"{width: percentile}\"></div>\n\t\t\t\t\t<div class=\"taroimg-progress-text\">{{percentile}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<input class=\"taroimg-input\" type=\"file\" name=\"file\" @change=\"fileChangeHandler\" ref=\"file\">\n    </form>\n    </div>\n    `,\n    data: function(){\n      return {\n        dropMsg: TaroimgUploader.dropMsg,\n        uploading: false,\n        undroppable: !window.FileReader,\n        btnLabel: TaroimgUploader.btnLabel,\n        nonce: TaroimgUploader.nonce,\n        loaded: 0,\n        total: 0,\n        onDrag: false\n      };\n    },\n    props: {\n      directory: {\n        type: String,\n        required: true\n      }\n    },\n    computed: {\n      actionUrl: function(){\n        return TaroimgUploader.endpoint + this.directory;\n      },\n      formId: function(){\n        return `taroimg-${this.directory}`;\n      },\n      percentile: function(){\n        if(!this.total){\n          return '';\n        }else{\n          return Math.round( this.loaded / this.total * 100 ) + '%';\n        }\n      },\n    },\n    methods: {\n      upload: function($form, formData){\n        // Avoid multiple uploading.\n        if(this.uploading){\n          return;\n        }\n        this.uploading = true;\n        let self = this;\n        $.ajax({\n          url: $form.attr('action'),\n          method: 'post',\n          dataType: 'json',\n          data: formData,\n          processData: false,\n          contentType: false,\n          xhr : function(){\n            let XHR = $.ajaxSettings.xhr();\n            if(XHR.upload){\n              XHR.upload.addEventListener('progress',function(e){\n                self.loaded = e.loaded;\n                self.total  = e.total;\n              }, false);\n            }\n            return XHR;\n          }\n        }).done(function( res ) {\n          $form[0].reset();\n          self.$emit('upload-finished', res);\n        }).fail(function( response ) {\n          self.$emit('upload-error', response);\n        }).always(function(){\n          self.uploading = false;\n          self.loaded = 0;\n          self.total  = 0;\n        });\n      },\n\n      submitForm: function(){\n        // Send file via Ajax\n        let $form = $(this.$refs.form);\n        let formData = new FormData( this.$refs.form );\n        this.upload($form, formData);\n      },\n\n      /**\n       * Trigger file select.\n       */\n      openFile: function(){\n        this.$refs.file.dispatchEvent(new Event('click'));\n      },\n\n      /**\n       * Trigger submit if file selected.\n       *\n       * @param {Event} event\n       */\n      fileChangeHandler: function(event){\n        if(event.target.files.length){\n          this.submitForm();\n        }\n      },\n\n      dragOver: function(event){\n        this.onDrag = true;\n        return false;\n      },\n\n      dragEnter: function(){\n        return false;\n      },\n\n      dragLeave: function(){\n        this.onDrag = false;\n        return false;\n      },\n      dropHandler: function(event){\n        // Get file.\n        if(!event.dataTransfer.files.length){\n          return false;\n        }\n        event.stopPropagation();\n        // Only 1 file.\n        let file = event.dataTransfer.files[0];\n        let form = this.$refs.form;\n        let formData = new FormData( form );\n        formData.append('file', file);\n        this.upload($(form), formData);\n        return false;\n      }\n    }\n  });\n})(jQuery);\n"]}