{"version":3,"sources":["components/uploader.js"],"names":["$","Vue","component","buttonId","dropMsg","TaroimgUploader","percentile","undroppable","total","FileReader","btnLabel","nonce","loaded","onDrag","upload","directory","type","String","required","postId","self","url","$form","data","processData","contentType","endpoint","this","formId","Math","reset","methods","uploading","formData","submitForm","ajax","method","dataType","xhr","XHR","ajaxSettings","openFile","addEventListener","e","done","res","fileChangeHandler","event","target","fail","response","$emit","always","dragOver","dragEnter","$refs","form","FormData","dragLeave","dataTransfer","files","length","dropHandler","stopPropagation","file","append","jQuery"],"mappings":";;;;;;;;;;;CAMA,SAAAA,GAOEC,IAAIC,UAAU,oBAAdD,SAAAA,myCA+DIE,KAAAA,WACE,OARMC,QAAAC,gBAAAD,QAURE,WAAY,EACVC,aAASC,OAAMC,WACbC,SAAOL,gBAAPK,SACDC,MAAIN,gBAAAM,MACHC,OAAA,EACDJ,MAAA,EACFK,QAAA,IAGDC,OACEC,WACAC,KAAGC,OACDC,UAAA,GAEFC,QACAH,KAAII,OACJpB,UAAO,EACLqB,QAAKC,IAGLC,UACAC,UAAAA,WACAC,OAAAA,gBANKC,SAAAC,KAAAZ,WAQHa,OAAA,WACA,MAAA,WAAAD,KAAcZ,WAEVK,SAAAA,WACAA,MAAAA,sBAAAO,KAAAZ,WAEHT,WAAA,WACD,OAAAqB,KAAAnB,MAGFqB,KAASC,MAATH,KAAAf,OAAAe,KAAAnB,MAAA,KAAA,IAFC,KAMFuB,SACCX,OAAAA,SAAKY,EAAYC,GAEjBb,IAAAA,KAAKZ,UAALY,CA3BFO,KAAKK,WAAY,EA+BnBE,IAAAA,EAAYP,KACV3B,EAAAmC,MACAd,IAAIC,EAAQtB,KAAE,UACdoC,OAAIH,OACJI,SAAYf,OAzCPC,KAAAU,EAaHT,aAAa,EA+BjBC,aAAA,EA7BIa,IAAM,WACJ,IAAIC,EAAMvC,EAAEwC,aAAaF,MAOzB,OAwBNG,EAAU3B,QACRyB,EAAAzB,OAAA4B,iBAAA,WAAA,SAAAC,GAhDKvB,EAAAR,OAAA+B,EAAA/B,OAoBGQ,EAAKZ,MAASmC,EAAEnC,QA+B1B,GA5Ba+B,KAERK,KAAK,SAAUC,GA+BpBC,EAAAA,GAAAA,QACE1B,EAAG2B,MAAMC,kBAAoBH,KAC3BI,KAAKf,SAALgB,GACD9B,EAAA+B,MAAA,eAAAD,KA3DIE,OAAA,WA+BHhC,EAAKY,WAAY,EA+BrBqB,EAAAA,OAAU,EACRjC,EAAKP,MAAS,MAIhByC,WAAW,WAnEJ,IAAAhC,EAAAtB,EAAA2B,KAAA4B,MAAAC,MAwCDvB,EAAW,IAAIwB,SAAU9B,KAAK4B,MAAMC,MA+B1CE,KAAAA,OAAWpC,EAAAW,IAMTQ,SAAIM,SAAMY,KASVb,kBAAcU,SAAOvB,GACrBc,EAAOC,OAAPY,MAAAC,QACDlC,KAAAO,cA1BDmB,SAAU,SAASN,GAEjB,OADApB,KAAKd,QAAS,GACP,GAGTyC,UAAW,WACT,OAAO,GAGTI,UAAW,WAET,OADA/B,KAAKd,QAAS,GACP,GAETiD,YAAa,SAASf,GAEpB,IAAIA,EAAMY,aAAaC,MAAMC,OAC3B,OAAO,EAETd,EAAMgB,kBAEN,IAAIC,EAAOjB,EAAMY,aAAaC,MAAM,GAChCJ,EAAO7B,KAAK4B,MAAMC,KAClBvB,EAAW,IAAIwB,SAAUD,GAG7B,OAFAvB,EAASgC,OAAO,OAAQD,GACxBrC,KAAKb,OAAOd,EAAEwD,GAAOvB,IACd,MAxKf,CA4KGiC","file":"../../components/uploader.js","sourcesContent":["/*!\n * File uploader\n *\n * wpdeps=jquery,vue-js\n */\n\n/*global TaroimgUploader: false*/\n\n(function ($) {\n\n  'use strict';\n\n\n  Vue.component('taroimg-uploader', {\n    template: `\n    <div>\n\n    <form :action=\"actionUrl\" enctype=\"multipart/form-data\" method=\"post\"\n\t\t\t:class=\"{'taroimg-form': true, undroppable: undroppable, uploading: uploading}\"\n\t\t\t:id=\"formId\"\n\t\t\t@submit.prevent=\"submitForm\" ref=\"form\">\n\t\t\t<input type=\"hidden\" name=\"_wpnonce\" :value=\"nonce\" />\n\t\t\t<input type=\"hidden\" name=\"id\" :value=\"postId\" />\n\t\t\t<div :class=\"{'taroimg-dropzone': true, on: onDrag}\"\n\t\t\t    @dragover.prevent.stop=\"dragOver\"\n\t\t\t    @dragenter.prevent.stop=\"dragEnter\"\n\t\t\t    @dragLeave.prevent.stop=\"dragLeave\"\n\t\t\t    @drop.prevent=\"dropHandler\"\n\t\t\t    >\n\t\t\t\t<p class=\"taroimg-description\">\n\t\t\t\t\t<span v-if=\"!undroppable\" class=\"taroimg-drop-here\">\n\t\t\t\t\t    {{dropMsg}}\n\t\t\t\t\t    <br />\n                    </span>\n\t\t\t\t\t<label :for=\"buttonId\" class=\"taroimg-button\" type=\"button\" @click=\"openFile($event)\">{{btnLabel}}</label>\n\t\t\t\t</p>\n\t\t\t\t\n\t\t\t\t<div class=\"taroimg-progress-bar\">\n\t\t\t\t\t<div class=\"taroimg-progress-inner\" :style=\"{width: percentile}\"></div>\n\t\t\t\t\t<div class=\"taroimg-progress-text\">{{percentile}}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<input class=\"taroimg-input\" :id=\"buttonId\" type=\"file\" name=\"file\" @change=\"fileChangeHandler\" ref=\"file\">\n    </form>\n    </div>\n    `,\n    data: function(){\n      return {\n        dropMsg: TaroimgUploader.dropMsg,\n        uploading: false,\n        undroppable: !window.FileReader,\n        btnLabel: TaroimgUploader.btnLabel,\n        nonce: TaroimgUploader.nonce,\n        loaded: 0,\n        total: 0,\n        onDrag: false\n      };\n    },\n    props: {\n      directory: {\n        type: String,\n        required: true\n      },\n      postId: {\n        type: Number,\n        required: false,\n        default: 0\n      }\n    },\n    computed: {\n      actionUrl: function(){\n        return TaroimgUploader.endpoint + this.directory;\n      },\n      formId: function(){\n        return `taroimg-${this.directory}`;\n      },\n      buttonId: function(){\n        return `taroimg-file-input-${this.directory}`;\n      },\n      percentile: function(){\n        if(!this.total){\n          return '';\n        }else{\n          return Math.round( this.loaded / this.total * 100 ) + '%';\n        }\n      },\n    },\n    methods: {\n      upload: function($form, formData){\n        // Avoid multiple uploading.\n        if(this.uploading){\n          return;\n        }\n        this.uploading = true;\n        let self = this;\n        $.ajax({\n          url: $form.attr('action'),\n          method: 'post',\n          dataType: 'json',\n          data: formData,\n          processData: false,\n          contentType: false,\n          xhr : function(){\n            let XHR = $.ajaxSettings.xhr();\n            if(XHR.upload){\n              XHR.upload.addEventListener('progress',function(e){\n                self.loaded = e.loaded;\n                self.total  = e.total;\n              }, false);\n            }\n            return XHR;\n          }\n        }).done(function( res ) {\n          $form[0].reset();\n          self.$emit('upload-finished', res);\n        }).fail(function( response ) {\n          self.$emit('upload-error', response);\n        }).always(function(){\n          self.uploading = false;\n          self.loaded = 0;\n          self.total  = 0;\n        });\n      },\n\n      submitForm: function(){\n        // Send file via Ajax\n        let $form = $(this.$refs.form);\n        let formData = new FormData( this.$refs.form );\n        this.upload($form, formData);\n      },\n\n      /**\n       * Trigger file select.\n       */\n      openFile: function(event){\n        //this.$refs.file.dispatchEvent(event);\n      },\n\n      /**\n       * Trigger submit if file selected.\n       *\n       * @param {Event} event\n       */\n      fileChangeHandler: function(event){\n        if(event.target.files.length){\n          this.submitForm();\n        }\n      },\n\n      dragOver: function(event){\n        this.onDrag = true;\n        return false;\n      },\n\n      dragEnter: function(){\n        return false;\n      },\n\n      dragLeave: function(){\n        this.onDrag = false;\n        return false;\n      },\n      dropHandler: function(event){\n        // Get file.\n        if(!event.dataTransfer.files.length){\n          return false;\n        }\n        event.stopPropagation();\n        // Only 1 file.\n        let file = event.dataTransfer.files[0];\n        let form = this.$refs.form;\n        let formData = new FormData( form );\n        formData.append('file', file);\n        this.upload($(form), formData);\n        return false;\n      }\n    }\n  });\n})(jQuery);\n"]}